<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="app.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
  ></script>
    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="index.js"></script>
    <script src="./opentok-network-test.js""></script>
    <title>Participant View</title>
  </head>
  <body>
    <div id="WaitingRoomContainer">
      <div id="banner">
          <!-- <h1><span class="badge bg-secondary">You're on the waiting Room. Please wait for the host to join</span></h1> -->
          <div class="alert alert-dark" role="alert">
              Waiting for the host to connect. Please make sure that your microphone and camera works
            </div>
      </div>

      <div id="controls">
        <!-- <div class="iconButton" id="cameraButton"> -->
      <div class="dropdown">
        <button class="iconButton" id="cameraButton">
          <img
            src="./icons/camera-video-fill.svg"
            id="cameraIcon"
            alt=""
            width="100%"
          />
        </button>
          <select
            class="btn btn-secondary dropdown-toggle"
              type="button"
              data-bs-toggle="dropdwon"
              aria-expanded="false"
              id="videoInputs"
              aria-labelledby="dropdownMenuVideo"
              
            >
            <option class="dropdown-item" selected>Chango video source</option>

          </select>
      </div>

        <!-- <button class="iconButton" id="micButton">
          <img src="./icons/mic-fill.svg" id="micIcon" alt="" width="100%" />
        </button> -->

        <div class="dropdown">
          <button class="iconButton" id="micButton">
            <img src="./icons/mic-fill.svg" id="micIcon" alt="" width="100%" />
          </button>
          
          <select
            class="btn btn-secondary dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              id="audioInputs"
              aria-labelledby="dropdownAudio"
            >
            <option class="dropdown-item" selected>Chango Audio source</option>
          </select>
        </div>

        <div><progress id="audioMeter" max="100" value="0"> 0% </progress></div>
      </div>
    </div>
    <div>
        <div id="publisher">
            <progress id="progress" max="100" value="0"> 0% </progress>
              <!-- <figure>
                <figcaption>Listen to the T-Rex:</figcaption>
                <audio id="audio" controls src="./file_example_MP3_700KB.mp3">
                  Your browser does not support the
                  <code>audio</code> element.
                </audio>
              </figure> -->
            <!-- </div>
            <figure>
              <figcaption>Listen to the T-Rex:</figcaption>
              <audio id="audio" controls src="./file_example_MP3_700KB.mp3">
                Your browser does not support the
                <code>audio</code> element.
              </audio>
            </figure>
          </div> -->
        </div>
    
        <div id="subscriber"></div>
    </div>
   
  </body>
  <script>
    const basicUrl = 'http://localhost:3000';
    const cameraButton = document.getElementById('cameraButton');
    const micButton = document.getElementById('micButton');
    const publisherOptions = {
      insertMode: 'append',
      width: '100%',
      height: '100%'
    };
    let session = null;
    let waitingRoompublisher = null;
    let hasVideo = true;
    let hasAudio = true;
    let isPublishing = false;
    let precallTestDone = false

    async function getCredentials() {
      // Default
      try {
        const url = `/api/room/${roomName}?role=participant`;
        const config = {};
        const response = await fetch(`${basicUrl}${url}`, config);
        const data = await response.json();
        console.log(data);
        if (data.apiKey && data.sessionId && data.token) {
          roomApiKey = data.apiKey;
          roomSessionId = data.sessionId;
          roomToken = data.token;
          return Promise.resolve(data);
        }
        return Promise.reject(new Error('Credentials Not Valid'));
      } catch (error) {
        console.log(error.message);
        return Promise.reject(error);
      }
    }

    getCredentials().then(data => {
      initializeWaitingRoom(data);
    });

    function initializeWaitingRoom(data) {
      const { apiKey, sessionId, token } = data;
      session = OT.initSession(apiKey, sessionId);

      session.on('connectionCreated', function(event) {
        connectionCount += 1;
        console.log('[connectionCreated]', connectionCount);
        usersConnected.push(event.connection);
        console.log(usersConnected);

        if (isHostPresent() || event.connection.data === 'admin') {
          if(precallTestDone){
          handlePublisher(waitingRoompublisher);
          }
          else{
             waitForTestEnd(waitingRoompublisher)
          }
        }
      });

      session.on('connectionDestroyed', event => {
        connectionCount -= 1;
        console.log('[connectionDestroyed]', connectionCount);
        usersConnected = usersConnected.filter(connection => {
          return connection.id != event.connection.id;
        });
        connectionCount -= 1;
        console.log(usersConnected);
      });

      session.on('streamCreated', event => {
        // console.log('event');
        const subscriberOptions = {
          insertMode: 'append',
          width: '100%',
          height: '100%'
        };
        session.subscribe(
          event.stream,
          'subscriber',
          subscriberOptions,
          handleError
        );
      });

      // initialize the publisher

      waitingRoompublisher = OT.initPublisher(
        'publisher',
        publisherOptions,
        handleError
      );

      waitingRoompublisher.on({
        accessAllowed: event => {
          console.log('accessAllowed');
          refreshDeviceList(waitingRoompublisher);
        },
        accessDenied: () => {
          alert('Please grant devices access');
          // The user has denied access to the camera and mic.
        },
        audioLevelUpdated: event => {
          calculateAudioLevel(event.audioLevel);
        },
        streamCreated: e => {
          console.log('the participant started streaming');
          isPublishing = true;
        },
        streamDestroyed: e => {
          isPublishing = false;
        }
      });

      // Connect to the session
      session.connect(token, error => {
        if (error) {
          handleError(error);
        } else {
          console.log('Session Connected');
        }
      });
    }


    function handlePublisher(pub) {
      console.log('[handlePublish]', pub);
      if (!isPublishing && connectionCount > 1) {
        session.publish(pub, handleError);
      } else if (connectionCount === 1 && pub) {
        session.unpublish(pub);
      }
    }

    const calculateAudioLevel = audioLevel => {
      let movingAvg = null;
      if (movingAvg === null || movingAvg <= audioLevel) {
        movingAvg = audioLevel;
      } else {
        movingAvg = 0.8 * movingAvg + 0.2 * audioLevel;
      }
      // console.log(movingAvg);
      // 1.5 scaling to map the -30 - 0 dBm range to [0,1]
      const currentLogLevel = Math.log(movingAvg) / Math.LN10 / 1.5 + 1;
      setLogLevel(Math.min(Math.max(currentLogLevel, 0), 1) * 100);
      // console.log(Math.min(Math.max(currentLogLevel, 0), 1) * 100);
    };

    const setLogLevel = logLevel => {
      document.getElementById('audioMeter').value = logLevel;
    };

    const toggleVideo = () => {
      hasVideo = !hasVideo;
      if (!hasVideo) {
        document.getElementById('cameraIcon').src =
          './icons/camera-video-off-fill.svg';
      } else {
        document.getElementById('cameraIcon').src =
          './icons/camera-video-fill.svg';
      }
      waitingRoompublisher.publishVideo(hasVideo);
    };

    const toggleAudio = () => {
      hasAudio = !hasAudio;
      if (!hasAudio) {
        document.getElementById('micIcon').src = './icons/mic-mute-fill.svg';
      } else {
        document.getElementById('micIcon').src = './icons/mic-fill.svg';
      }

      waitingRoompublisher.publishAudio(hasAudio);
    };

    cameraButton.addEventListener('click', () => {
      toggleVideo();
    });

    document.getElementById('videoInputs').addEventListener('change', e => {
      onVideoSourceChanged(e, waitingRoompublisher);
    });
    navigator.mediaDevices.ondevicechange = () => {
      console.log('Media Devices change detected, refreshing list');
      refreshDeviceList();
    };

    micButton.addEventListener('click', () => {
      toggleAudio();
    });

    document.getElementById('audioInputs').addEventListener('change', e => {
      e.preventDefault();

      onAudioSourceChanged(e, waitingRoompublisher)
    });

    (async()=>{

    const progressIndicator = setInterval(()=>{
      let currentProgress = document.getElementById("progress").value
      document.getElementById("progress").value += 5
      if(currentProgress === 100){
        clearInterval(progressIndicator)
        // document.getElementById("progress").value = 0
      }
    }, 1000)

    try{
      const result = await startTest()
      precallTestDone = true
      const classResult = result.text === `You're all set!` ? 'alert-success' : 'alert-warning'
      const precallResult = `
      <div class="alert ${classResult} alert-dismissible fade show" role="alert">
      ${result.text}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`
      document.getElementById("publisher").insertAdjacentHTML("beforeend" ,precallResult )
      document.getElementById("progress").style.display = 'none'
    }
    catch(e) {console.log(e)}

})()
  </script>
</html>
